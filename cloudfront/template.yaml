AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Demo CloudFront Distribution.
  Managed by dev-platform

Parameters:
  Environment:
    Description: The name of the environment to deploy to.
    Type: String
    AllowedPattern: ((production)|(integration)|(staging)|(build)|(dev))

Mappings:
  EnvironmentConfiguration:
    "dev":
      CloudfrontCertificate: "arn:aws:acm:us-east-1:842766856468:certificate/ece18c99-4a54-42c2-8da6-5e0acd244f60" # we have to make this manually as it lives in us-east-1

Resources:

  CloudfrontDistribution:
    #checkov:skip=CKV_AWS_86: No Access Logs setup is required
    #checkov:skip=CKV_AWS_68: No WAF is required
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - !Sub "cloudfront-estimate.${Environment}.platform.sandpit.account.gov.uk"
        Origins:
          - DomainName:
              Fn::ImportValue:
                Fn::Sub: "DefaultApiDomainName-${Environment}"
            OriginPath:
              Fn::ImportValue:
                Fn::Sub: "DefaultApiStage-${Environment}"
            Id: RestAPIGatewayOrigin
            CustomOriginConfig:
              OriginProtocolPolicy: 'https-only'
              OriginSSLProtocols:
                - TLSv1.2
        Enabled: 'true'
        Comment: CloudfrontToRestAPI
        PriceClass: PriceClass_100
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad #Managed-CachingDisabled
          TargetOriginId: RestAPIGatewayOrigin
          OriginRequestPolicyId: 33f36d7e-f396-46d9-90e0-52428a34d9dc #Managed-AllViewerAndCloudFrontHeaders-2022-06
          ViewerProtocolPolicy: redirect-to-https
          FunctionAssociations:
            - EventType: viewer-request
              FunctionARN: !ImportValue CloudfrontTICFFunctionArn
        ViewerCertificate:
          MinimumProtocolVersion: TLSv1.2_2018
          SslSupportMethod: sni-only
          AcmCertificateArn: !FindInMap [ EnvironmentConfiguration, !Ref Environment,  CloudfrontCertificate ]

Outputs:
  CloudfrontDistDomain:
    Description: Default distribution domain name
    Value: !GetAtt CloudfrontDistribution.DomainName
    Export:
      Name: !Sub "CloudfrontDistDomain-${Environment}"
